<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>AI Guard – TikTok Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--accent:#00f5ff;--bg:#0d0d0d;--card:#1a1a1a;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif}
    body{background:var(--bg);color:#fff;display:flex;flex-direction:column;align-items:center;padding:2rem}
    h1{margin-bottom:1.2rem;font-size:2rem;letter-spacing:1px}
    .card{background:var(--card);border-radius:12px;padding:1.5rem;width:100%;max-width:480px;margin-bottom:1.5rem}
    label{display:block;margin-bottom:.5rem;font-weight:600}
    input[type=file]{width:100%;margin-bottom:1rem}
    textarea{width:100%;min-height:90px;padding:.7rem;border-radius:8px;border:none;resize:vertical;font-size:1rem}
    .btn{background:var(--accent);color:#000;border:none;padding:.8rem 1.4rem;border-radius:8px;font-weight:700;cursor:pointer;width:100%;font-size:1rem;margin-top:1rem;transition:.3s}
    .btn:hover{filter:brightness(1.15)}
    .btn:disabled{background:#555;color:#222;cursor:not-allowed}
    #aiBot{width:160px;height:160px;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:none;z-index:10}
    #aiBot svg{width:100%;height:100%}
    .preview-box{position:relative;margin:1rem auto;width:160px;height:160px;border-radius:12px;overflow:hidden;display:none;animation:popIn .6s ease-out forwards}
    @keyframes popIn{0%{opacity:0;transform:scale(.7) rotate(-5deg)}100%{opacity:1;transform:scale(1) rotate(0)}}
    .preview-box img,.preview-box video{width:100%;height:100%;object-fit:cover;border-radius:12px}
    .pulse{animation:pulse .8s infinite}@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(0,245,255,.7)}70%{box-shadow:0 0 0 12px rgba(0,245,255,0)}}
    .shake{animation:shake .25s 2}@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-3px)}75%{transform:translateX(3px)}}
    #result video{width:100%;border-radius:10px;margin-top:1rem;background:#000}
    .hidden{display:none}
    #log{color:#f00;margin-top:.5rem;font-size:.9rem}
    /* فيديو مخفي لنسخ إطاراته */
    #hiddenVid{position:absolute;top:-9999px;left:-9999px;width:1px;height:1px;}
</style>
</head>
<body>
  <h1>حامي AI – توليد فيديو تيك توك</h1>

  <div class="card">
    <label>📸 ارفع صورة أو فيديو (أقصى مدة 60 ثانية)</label>
    <input id="mediaFile" type="file" accept="image/*,video/*">
    <div id="previewBox" class="preview-box">
      <img id="prevImg" style="display:none;">
      <video id="prevVid" muted loop style="display:none;"></video>
    </div>
  </div>

  <div class="card">
    <label>✍️ النص (عربي أو إنجليزي)</label>
    <textarea id="textInput" placeholder="اكتب الجملة التي تريد ظهورها كلمة-كلمة..."></textarea>
  </div>

  <div id="aiBot">
    <svg viewBox="0 0 100 100">
      <circle cx="50" cy="25" r="12" fill="var(--accent)"/>
      <rect x="40" y="37" width="20" height="30" rx="4" fill="var(--accent)"/>
      <rect x="30" y="45" width="10" height="20" rx="3" fill="var(--accent)"/>
      <rect x="60" y="45" width="10" height="20" rx="3" fill="var(--accent)"/>
      <rect x="43" y="67" width="6" height="18" rx="2" fill="var(--accent)"/>
      <rect x="51" y="67" width="6" height="18" rx="2" fill="var(--accent)"/>
      <rect x="75" y="35" width="4" height="30" fill="#fff" transform="rotate(45 77 50)"/>
    </svg>
  </div>

  <button id="genBtn" class="btn">🎬 أنشئ الفيديو</button>
  <div id="log"></div>

  <div id="result" class="card hidden">
    <video id="outVideo" controls></video>
    <div style="display:flex;gap:.5rem;margin-top:1rem">
      <button id="downBtn" class="btn">تحميل الفيديو</button>
      <button id="tiktokBtn" class="btn">فتح تيك توك</button>
    </div>
  </div>

  <!-- فيديو مخفي لنسخ إطاراته -->
  <video id="hiddenVid" muted playsinline style="display:none;"></video>

<script>
const log=m=>document.getElementById('log').textContent=m;
const sleep=ms=>new Promise(r=>setTimeout(r,ms));

/* ====== اختيار ملف + معاينة ====== */
const fileIn=document.getElementById('mediaFile');
const pBox=document.getElementById('previewBox');
const pImg=document.getElementById('prevImg');
const pVid=document.getElementById('prevVid');
const hiddenVid=document.getElementById('hiddenVid');

fileIn.addEventListener('change',()=>{
  const f=fileIn.files[0];
  if(!f){pBox.style.display='none';hiddenVid.src='';return;}
  fileIn.parentElement.classList.add('shake');
  setTimeout(()=>fileIn.parentElement.classList.remove('shake'),500);
  const url=URL.createObjectURL(f);
  if(f.type.startsWith('image/')){
    pVid.style.display='none';hiddenVid.style.display='none';
    pImg.src=url;pImg.style.display='block';
    hiddenVid.src=''; // لا فيديو
  }else{
    pImg.style.display='none';
    pVid.src=url;pVid.style.display='block';
    pVid.play();
    // ن copy إلى الفيديو المخفي
    hiddenVid.src=url;
  }
  pBox.style.display='block';
});

/* ====== توليد الفيديو ====== */
let audioCtx;
function initAudio(){
  if(!audioCtx)audioCtx=new (window.AudioContext||window.webkitAudioContext)();
}
function beep(freq=600,dur=60){
  initAudio();
  try{
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.frequency.value=freq;o.type='square';
    g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+dur/1000);
    o.start();o.stop(audioCtx.currentTime+dur/1000);
  }catch(e){}
}

async function generateVideo(){
  const txt=document.getElementById('textInput').value.trim();
  if(!txt)throw new Error('يرجى كتابة نص');
  const canvas=document.createElement('canvas');
  canvas.width=1080;canvas.height=1920;
  const ctx=canvas.getContext('2d');
  const stream=canvas.captureStream(30);
  const recorder=new MediaRecorder(stream,{mimeType:'video/webm'});
  const chunks=[];let duration=5; // افتراضي
  const f=fileIn.files[0];
  let srcUrl='';
  if(f){
    if(f.type.startsWith('video/')){
      srcUrl=URL.createObjectURL(f);
      await new Promise((rs)=>{
        hiddenVid.onloadedmetadata=()=>{
          duration=Math.min(60,Math.floor(hiddenVid.duration));
          rs();
        };
        hiddenVid.src=srcUrl;
      });
    }else{
      duration=5;
    }
  }
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:'video/webm'});
    const v=document.getElementById('outVideo');
    v.src=URL.createObjectURL(blob);
    document.getElementById('result').classList.remove('hidden');
  };

  // ننتظر أول إطار من الفيديو قبل التسجيل
  if(hiddenVid.src){
    // إذا لم يكن شغّالاً بعد، نضغط play يدوياً
    if(hiddenVid.paused){
      log('اضغط «ابدأ» لتشغيل الفيديو ثم يبدأ التوليد تلقائياً');
      const startBtn=document.createElement('button');
      startBtn.textContent='ابدأ';
      startBtn.className='btn';
      document.getElementById('log').after(startBtn);
      await new Promise(rs=>startBtn.onclick=()=>{
        hiddenVid.play();
        startBtn.remove();
        rs();
      });
    }
    await new Promise(rs=>hiddenVid.onplaying=rs);
    hiddenVid.currentTime=0;
  }
  recorder.start();

  const totalFrames=duration*30;
  const words=txt.split(' ');
  let frame=0,wordIndex=0;
  const aiBot=document.getElementById('aiBot');
  aiBot.style.display='block';
  aiBot.animate([{opacity:0,scale:0.3},{opacity:0.7,scale:1}],{duration:900,easing:'ease-out',fill:'forwards'});

  while(frame<=totalFrames){
    frame++;
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bg');
    ctx.fillRect(0,0,canvas.width,canvas.height);
    // رسم الفيديو/الصورة
    if(hiddenVid.src){
      const scale=Math.max(canvas.width/hiddenVid.videoWidth,canvas.height/hiddenVid.videoHeight);
      const w=hiddenVid.videoWidth*scale,h=hiddenVid.videoHeight*scale;
      ctx.drawImage(hiddenVid,-(w-canvas.width)/2,-(h-canvas.height)/2,w,h);
      ctx.fillStyle='rgba(0,0,0,0.25)';ctx.fillRect(0,0,canvas.width,canvas.height);
    }else if(pImg.src){
      const img=pImg;
      const scale=Math.max(canvas.width/img.naturalWidth,canvas.height/img.naturalHeight);
      const w=img.naturalWidth*scale,h=img.naturalHeight*scale;
      ctx.drawImage(img,-(w-canvas.width)/2,-(h-canvas.height)/2,w,h);
      ctx.fillStyle='rgba(0,0,0,0.25)';ctx.fillRect(0,0,canvas.width,canvas.height);
    }
    // الروبوت خلف النص
    ctx.save();ctx.globalAlpha=0.7;
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.scale(1.4,1.4);
    drawBotSVG(ctx);
    ctx.restore();
    // النص كلمة-كلمة
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent');
    ctx.font='bold 80px Cairo';ctx.textAlign='center';
    const visible=words.slice(0,wordIndex).join(' ');
    ctx.fillText(visible,canvas.width/2,canvas.height/2+60);
    if(frame%30===0)wordIndex=Math.min(wordIndex+1,words.length);
    if(frame%30===0)beep(600,40);
    await sleep(1000/30);
  }
  recorder.stop();
  aiBot.style.display='none';
}

function drawBotSVG(ctx){
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent');
  ctx.beginPath();ctx.arc(50,25,12,0,Math.PI*2);ctx.fill();
  ctx.fillRect(40,37,20,30);
  ctx.fillRect(30,45,10,20);
  ctx.fillRect(60,45,10,20);
  ctx.fillRect(43,67,6,18);
  ctx.fillRect(51,67,6,18);
  ctx.fillStyle='#fff';
  ctx.save();
  ctx.translate(75,50);ctx.rotate(Math.PI/4);
  ctx.fillRect(-2,-15,4,30);
  ctx.restore();
}

/* ====== أحداث الأزرار ====== */
document.getElementById('genBtn').addEventListener('click',async()=>{
  log('');
  const btn=document.getElementById('genBtn');
  btn.disabled=true;btn.textContent='جارِ التوليد...';
  try{
    await generateVideo();
    btn.disabled=false;btn.textContent='🎬 أنشئ الفيديو';
  }catch(err){
    log('خطأ: '+err.message);
    btn.disabled=false;btn.textContent='🎬 أنشئ الفيديو';
  }
});

document.getElementById('downBtn').addEventListener('click',()=>{
  const v=document.getElementById('outVideo');
  const a=document.createElement('a');
  a.href=v.src;
  a.download='AI_Guard_1080x1920.webm';
  a.click();
});

document.getElementById('tiktokBtn').addEventListener('click',()=>{
  window.open('https://www.tiktok.com/upload','_blank');
});
</script>
</body>
  </html>
  
