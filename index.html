<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>AI Guard – TikTok Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--accent:#00f5ff;--bg:#0d0d0d;--card:#1a1a1a;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif}
    body{background:var(--bg);color:#fff;display:flex;flex-direction:column;align-items:center;padding:2rem}
    h1{margin-bottom:1.2rem;font-size:2rem;letter-spacing:1px}
    .card{background:var(--card);border-radius:12px;padding:1.5rem;width:100%;max-width:480px;margin-bottom:1.5rem}
    label{display:block;margin-bottom:.5rem;font-weight:600}
    input[type=file]{width:100%;margin-bottom:1rem}
    textarea{width:100%;min-height:90px;padding:.7rem;border-radius:8px;border:none;resize:vertical;font-size:1rem}
    .btn{background:var(--accent);color:#000;border:none;padding:.8rem 1.4rem;border-radius:8px;font-weight:700;cursor:pointer;width:100%;font-size:1rem;margin-top:1rem;transition:.3s}
    .btn:hover{filter:brightness(1.15)}
    .btn:disabled{background:#555;color:#222;cursor:not-allowed}
    #aiBot{width:120px;height:120px;position:relative;margin:1.5rem auto;display:none}
    #aiBot svg{width:100%;height:100%}
    .type-char{opacity:0;animation:pop .08s forwards}
    @keyframes pop{to{opacity:1}}
    #result video{width:100%;border-radius:10px;margin-top:1rem;background:#000}
    .hidden{display:none}
    #log{color:#f00;margin-top:.5rem;font-size:.9rem}
  </style>
</head>
<body>
  <h1>حامي AI – توليد فيديو تيك توك</h1>

  <div class="card">
    <label>📸 ارفع صورة أو فيديو (اختياري)</label>
    <input id="mediaFile" type="file" accept="image/*,video/*">
  </div>

  <div class="card">
    <label>✍️ النص (عربي أو إنجليزي)</label>
    <textarea id="textInput" placeholder="اكتب الجملة التي تريد ظهورها حرفًا حرفًا..."></textarea>
  </div>

  <div id="aiBot">
    <svg viewBox="0 0 100 100">
      <circle cx="50" cy="30" r="12" fill="var(--accent)"/>
      <rect x="40" y="42" width="20" height="30" rx="4" fill="var(--accent)"/>
      <rect x="35" y="50" width="8" height="18" rx="3" fill="var(--accent)"/>
      <rect x="57" y="50" width="8" height="18" rx="3" fill="var(--accent)"/>
      <rect x="45" y="72" width="5" height="12" rx="2" fill="var(--accent)"/>
      <rect x="50" y="72" width="5" height="12" rx="2" fill="var(--accent)"/>
    </svg>
  </div>

  <button id="genBtn" class="btn">🎬 أنشئ الفيديو</button>
  <div id="log"></div>

  <div id="result" class="card hidden">
    <video id="outVideo" controls></video>
    <div style="display:flex;gap:.5rem;margin-top:1rem">
      <button id="downBtn" class="btn">تحميل الفيديو</button>
      <button id="tiktokBtn" class="btn">فتح تيك توك</button>
    </div>
  </div>

<script>
const log=m=>document.getElementById('log').textContent=m;
const sleep=ms=>new Promise(r=>setTimeout(r,ms));

/* ========== مؤثرات صوتية ========== */
let audioCtx;
function initAudio(){
  if(!audioCtx)audioCtx=new (window.AudioContext||window.webkitAudioContext)();
}
function beep(freq=600,dur=60){
  initAudio();
  try{
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.frequency.value=freq;o.type='square';
    g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+dur/1000);
    o.start();o.stop(audioCtx.currentTime+dur/1000);
  }catch(e){console.warn('صوت غير متاح');}
}

/* ========== تأثير الكتابة ========== */
function typeWriter(el,text){
  el.innerHTML='';
  text.split('').forEach((ch,i)=>{
    const s=document.createElement('span');
    s.textContent=ch===' '?' \u2009':ch;
    s.className='type-char';
    s.style.animationDelay=`${i*60}ms`;
    el.appendChild(s);
  });
}

/* ========== ظهور الروبوت ========== */
function showBot(){
  const bot=document.getElementById('aiBot');
  bot.style.display='block';
  bot.animate([{opacity:0,scale:0.3},{opacity:1,scale:1}],{duration:900,easing:'ease-out',fill:'forwards'});
}

/* ========== توليد الفيديو ========== */
async function generateVideo(){
  const txt=document.getElementById('textInput').value.trim();
  if(!txt)throw new Error('يرجى كتابة نص');
  const canvas=document.createElement('canvas');
  canvas.width=1080;canvas.height=1920;
  const ctx=canvas.getContext('2d');
  const stream=canvas.captureStream(30);
  if(!stream)throw new Error('المتصفح لا يدعم التقاط الcanvas');

  const recorder=new MediaRecorder(stream,{mimeType:'video/webm'});
  const chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:'video/webm'});
    const v=document.getElementById('outVideo');
    v.src=URL.createObjectURL(blob);
    document.getElementById('result').classList.remove('hidden');
  };
  recorder.start();

  const imgFile=document.getElementById('mediaFile').files[0];
  let imgBitmap=null;
  if(imgFile){
    try{imgBitmap=await createImageBitmap(imgFile);}
    catch(e){log('لم يتمكن من تحميل الوسائط، سيكون هناك خلفية سوداء');}
  }

  let frame=0;const totalFrames=150;
  while(frame<=totalFrames){
    frame++;
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bg');ctx.fillRect(0,0,canvas.width,canvas.height);
    if(imgBitmap){
      const scale=Math.max(canvas.width/imgBitmap.width,canvas.height/imgBitmap.height);
      const w=imgBitmap.width*scale,h=imgBitmap.height*scale;
      ctx.drawImage(imgBitmap,-(w-canvas.width)/2,-(h-canvas.height)/2,w,h);
      ctx.fillStyle='rgba(0,0,0,0.35)';ctx.fillRect(0,0,canvas.width,canvas.height);
    }
    if(frame>20){
      ctx.save();ctx.globalAlpha=Math.min(1,(frame-20)/30);
      ctx.translate(canvas.width-180,120);
      drawBotSVG(ctx);ctx.restore();
    }
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent');
    ctx.font='bold 80px Cairo';ctx.textAlign='center';
    const chars=Math.floor((frame-10)/3);
    const visible=txt.slice(0,Math.max(0,chars));
    ctx.fillText(visible,canvas.width/2,canvas.height/2);
    if(frame>10&&chars<=txt.length&&chars%3===0)beep(600,40);
    await sleep(1000/30);
  }
  recorder.stop();
}

function drawBotSVG(ctx){
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent');
  ctx.beginPath();ctx.arc(50,30,12,0,Math.PI*2);ctx.fill();
  ctx.fillRect(40,42,20,30);
  ctx.fillRect(35,50,8,18);
  ctx.fillRect(57,50,8,18);
  ctx.fillRect(45,72,5,12);
  ctx.fillRect(50,72,5,12);
}

/* ========== أحداث الأزرار ========== */
document.getElementById('genBtn').addEventListener('click',async()=>{
  log('');
  const btn=document.getElementById('genBtn');
  btn.disabled=true;btn.textContent='جارِ التوليد...';
  typeWriter(document.querySelector('h1'),'يستعدّ الروبوت للحماية...');
  showBot();
  try{
    await generateVideo();
    btn.disabled=false;btn.textContent='🎬 أنشئ الفيديو';
    typeWriter(document.querySelector('h1'),'حامي AI – توليد فيديو تيك توك');
  }catch(err){
    log('خطأ: '+err.message);
    btn.disabled=false;btn.textContent='🎬 أنشئ الفيديو';
  }
});

document.getElementById('downBtn').addEventListener('click',()=>{
  const v=document.getElementById('outVideo');
  const a=document.createElement('a');
  a.href=v.src;
  a.download='AI_Guard_1080x1920.webm';
  a.click();
});

document.getElementById('tiktokBtn').addEventListener('click',()=>{
  window.open('https://www.tiktok.com/upload','_blank');
});
</script>
</body>
</html>
