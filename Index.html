<!doctype html>

<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok-style Video Generator (index.html)</title>
  <meta name="description" content="Generate vertical MP4 from an image with typing text effect. Works client-side.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{font-family: Roboto, system-ui, -apple-system, 'Segoe UI', Arial;}
    body{margin:0;padding:18px;background:#111;color:#eee;display:flex;flex-direction:column;gap:12px;min-height:100vh}
    .card{background:#0f1720;padding:14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.6)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    label{font-size:13px;color:#cbd5e1}
    input[type=file]{color:transparent}
    button, select, input[type=range]{padding:8px;border-radius:6px;border:1px solid #2b3440;background:#0b1220;color:#fff}
    textarea{width:100%;min-height:64px;padding:8px;border-radius:6px;border:1px solid #2b3440;background:#07101a;color:#fff}
    #preview{width:216px;height:384px;border-radius:8px;object-fit:cover;background:#222}
    canvas{display:none}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:12px;color:#94a3b8}
    a.button-like{display:inline-block;padding:8px 12px;border-radius:6px;background:#06b6d4;color:#001; text-decoration:none}
  </style>
</head>
<body>
  <div class="card">
    <h3 style="margin:0 0 8px 0;font-family:'Cairo', Roboto">TikTok-style Vertical Video Generator</h3>
    <div class="row" style="align-items:center">
      <div>
        <label>صورة (أو صورة افتراضية)</label><br>
        <input id="imageInput" type="file" accept="image/*">
      </div>
      <div>
        <label>عرض معاينة</label><br>
        <img id="preview" alt="preview"/>
      </div>
      <div style="flex:1;min-width:220px">
        <label>النص (Arabic / English)</label>
        <textarea id="textInput" placeholder="أدخل النص هنا / Enter text here">مرحباً. هذا نص تجريبي.</textarea>
        <div class="controls" style="margin-top:8px">
          <div>
            <label>اللغة</label><br>
            <select id="langSelect">
              <option value="auto">Auto</option>
              <option value="ar">Arabic</option>
              <option value="en">English</option>
            </select>
          </div>
          <div>
            <label>حجم الخط</label><br>
            <input id="fontSize" type="range" min="30" max="120" value="64">
          </div>
          <div>
            <label>مدة الفيديو (ثواني)</label><br>
            <input id="duration" type="range" min="2" max="8" value="4">
          </div>
        </div>
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <button id="generateBtn">إنشاء الفيديو</button>
      <a id="downloadBtn" class="button-like" style="display:none">تحميل الفيديو</a>
      <a id="tiktokBtn" class="button-like" style="display:none">فتح TikTok</a>
      <div id="log" class="small">جاهز.</div>
    </div>
  </div><canvas id="work" width="1080" height="1920"></canvas>

  <script type="module">
    import { createFFmpeg, fetchFile } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.11.7/dist/ffmpeg.min.js';

    const preview = document.getElementById('preview');
    const imageInput = document.getElementById('imageInput');
    const textInput = document.getElementById('textInput');
    const langSelect = document.getElementById('langSelect');
    const fontSizeInput = document.getElementById('fontSize');
    const generateBtn = document.getElementById('generateBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const tiktokBtn = document.getElementById('tiktokBtn');
    const log = document.getElementById('log');
    const canvas = document.getElementById('work');
    const ctx = canvas.getContext('2d');

    let loadedImage = null;
    let generatedUrl = null;

    imageInput.addEventListener('change', e=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      preview.src = url;
      const img = new Image();
      img.onload = ()=>{ loadedImage = img; URL.revokeObjectURL(url); };
      img.src = url;
    });

    // default preview image
    preview.src = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<?xml version='1.0' encoding='utf-8'?><svg xmlns='http://www.w3.org/2000/svg' width='1080' height='1920'><rect width='100%' height='100%' fill='%230b1220'/><text x='50%' y='50%' fill='%23eee' font-family='Cairo, Roboto, Arial' font-size='48' dominant-baseline='middle' text-anchor='middle'>Drop an image</text></svg>`);

    function detectArabic(text){
      return /[\u0600-\u06FF]/.test(text);
    }

    function setLog(s){ log.textContent = s; }

    async function generate() {
      setLog('Preparing...');
      generateBtn.disabled = true;
      downloadBtn.style.display = 'none';
      tiktokBtn.style.display = 'none';

      const text = textInput.value.trim();
      if(!text){ setLog('أدخل نصاً.'); generateBtn.disabled=false; return; }

      const lang = langSelect.value === 'auto' ? (detectArabic(text)?'ar':'en') : langSelect.value;
      const fontSize = parseInt(fontSizeInput.value,10);
      const duration = parseInt(document.getElementById('duration').value,10);
      const fps = 30;
      const totalFrames = Math.max(1, Math.floor(duration * fps));

      // draw image scaled to cover 1080x1920
      const bg = loadedImage || await loadDefaultImage();

      // render frames to data urls
      setLog('رسم الإطارات...');
      const frames = [];
      for(let i=0;i<totalFrames;i++){
        // typing progress: every frame reveal proportional characters
        const progress = i / (totalFrames - 1 || 1);
        const chars = Math.floor(progress * text.length);
        const partial = text.slice(0, chars);

        // draw background cover
        drawCoverImage(bg);

        // text style
        ctx.save();
        ctx.font = `${fontSize}px ${lang==='ar' ? 'Cairo':'Roboto'}`;
        ctx.textBaseline = 'middle';
        ctx.textAlign = 'center';
        // rtl handling
        if(lang==='ar'){
          ctx.direction = 'rtl';
        } else {
          ctx.direction = 'ltr';
        }

        // shadow
        ctx.fillStyle = 'rgba(0,0,0,0.45)';
        wrapTextShadow(partial, canvas.width/2, canvas.height*0.7, canvas.width - 120, fontSize + 10);

        // main text
        ctx.fillStyle = '#fff';
        wrapText(partial, canvas.width/2, canvas.height*0.7, canvas.width - 120, fontSize + 10);

        ctx.restore();

        frames.push(canvas.toDataURL('image/png'));
      }

      setLog('تحميل FFmpeg في المتصفح (قد يأخذ وقتاً)...');
      const ffmpeg = createFFmpeg({ log: false, corePath: 'https://unpkg.com/@ffmpeg/core@0.11.1/dist/ffmpeg-core.js' });
      try{
        await ffmpeg.load();
      }catch(e){ setLog('فشل تحميل ffmpeg. راجع اتصال الإنترنت.'); generateBtn.disabled=false; return; }

      setLog('إرسال الإطارات إلى ffmpeg...');
      for(let i=0;i<frames.length;i++){
        const name = `frame${String(i).padStart(4,'0')}.png`;
        const data = dataURLToUint8Array(frames[i]);
        ffmpeg.FS('writeFile', name, data);
      }

      setLog('إنشاء الفيديو...');
      // Build command
      // -r fps input -c:v libx264 -pix_fmt yuv420p -vf scale=1080:1920 out.mp4
      try{
        await ffmpeg.run('-framerate', String(fps), '-i', 'frame%04d.png', '-c:v', 'libx264', '-pix_fmt', 'yuv420p', '-vf', 'scale=1080:1920', 'out.mp4');
      }catch(e){ setLog('فشل معالجة الفيديو.'); generateBtn.disabled=false; return; }

      setLog('استخراج الملف الناتج...');
      const data = ffmpeg.FS('readFile', 'out.mp4');
      const blob = new Blob([data.buffer], { type: 'video/mp4' });
      if(generatedUrl) URL.revokeObjectURL(generatedUrl);
      generatedUrl = URL.createObjectURL(blob);

      downloadBtn.href = generatedUrl;
      downloadBtn.download = 'tiktok_video.mp4';
      downloadBtn.style.display = 'inline-block';
      tiktokBtn.style.display = 'inline-block';
      setLog('جاهز. يمكنك تحميل الفيديو أو فتح TikTok لنشره.');
    
      generateBtn.disabled = false;
    }

    function drawCoverImage(img){
      const cw = canvas.width, ch = canvas.height;
      // cover logic
      const r = Math.max(cw / img.width, ch / img.height);
      const w = img.width * r, h = img.height * r;
      const x = (cw - w) / 2, y = (ch - h) / 2;
      ctx.clearRect(0,0,cw,ch);
      ctx.drawImage(img, x, y, w, h);
      // optional dark overlay
      ctx.fillStyle = 'rgba(0,0,0,0.25)';
      ctx.fillRect(0,0,cw,ch);
    }

    function wrapText(text, x, y, maxWidth, lineHeight){
      const words = text.split(/\s+/);
      let line = '', testLine='';
      let dy = 0;
      const lines = [];
      for(let n=0;n<words.length;n++){
        const word = words[n];
        testLine = line + (line? ' ':'') + word;
        const metrics = ctx.measureText(testLine);
        if(metrics.width > maxWidth && line){
          lines.push(line);
          line = word;
        } else {
          line = testLine;
        }
      }
      lines.push(line);
      const startY = y - (lines.length-1)/2 * lineHeight;
      for(let i=0;i<lines.length;i++){
        ctx.fillText(lines[i], x, startY + i*lineHeight);
      }
    }

    function wrapTextShadow(text, x, y, maxWidth, lineHeight){
      ctx.shadowColor = 'rgba(0,0,0,0.6)';
      ctx.shadowBlur = 12;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 6;
      wrapText(text,x,y,maxWidth,lineHeight);
      ctx.shadowColor = 'transparent';
    }

    function dataURLToUint8Array(dataURL){
      const arr = dataURL.split(',');
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while(n--) u8arr[n] = bstr.charCodeAt(n);
      return u8arr;
    }

    async function loadDefaultImage(){
      // simple dark background as fallback
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='1080' height='1920'><rect width='100%' height='100%' fill='%230b1220'/></svg>`;
      const img = new Image();
      img.src = 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
      await img.decode();
      return img;
    }

    // Open TikTok intent (mobile) or web upload page fallback
    tiktokBtn.addEventListener('click', e=>{
      e.preventDefault();
      // try app scheme
      const appUrl = 'tiktok://upload';
      const webUrl = 'https://www.tiktok.com/upload';
      // on mobile this may open the native app. We open web fallback in a new tab.
      window.open(appUrl, '_blank');
      // also open web fallback shortly after
      setTimeout(()=> window.open(webUrl, '_blank'), 600);
    });

    generateBtn.addEventListener('click', generate);
  </script></body>
</html>
